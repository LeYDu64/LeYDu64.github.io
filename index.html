<script>
let players = [];
let currentPlayer = 0;
let villageWord = "";
let renegatWord = "";

// RÃ©cupÃ©ration Ã©lÃ©ments
const namesInput = document.getElementById("playerNames");
const renegatInput = document.getElementById("impostorCount");
const idiotInput = document.getElementById("idiotCount");
const roleReveal = document.getElementById("roleReveal");
const voteSection = document.getElementById("voteSection");
const resultScreen = document.getElementById("resultScreen");

function saveConfig(){
    localStorage.setItem("gameConfig", JSON.stringify({
        names: namesInput.value,
        renegats: renegatInput.value,
        idiots: idiotInput.value
    }));
}

function loadConfig(){
    let saved = JSON.parse(localStorage.getItem("gameConfig"));
    if(saved){
        namesInput.value = saved.names || "";
        renegatInput.value = saved.renegats || 0;
        idiotInput.value = saved.idiots || 0;
    }
}

function resetConfig(){
    localStorage.removeItem("gameConfig");
    location.reload();
}

function shuffle(array){
    for(let i = array.length - 1; i > 0; i--){
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function startGame(){

    let names = namesInput.value.split(",").map(n => n.trim()).filter(n => n);
    let count = names.length;
    let impostors = parseInt(renegatInput.value) || 0;
    let idiotCountValue = parseInt(idiotInput.value) || 0;

    // VÃ©rifications
    if(count < 3){
        alert("Minimum 3 joueurs.");
        return;
    }

    if(impostors < 0 || idiotCountValue < 0){
        alert("Nombre invalide.");
        return;
    }

    if(impostors + idiotCountValue >= count){
        alert("Trop de rÃ´les spÃ©ciaux par rapport au nombre de joueurs.");
        return;
    }

    if(impostors === 0 && idiotCountValue === 0){
        alert("Il faut au moins un RenÃ©gat ou un Idiot du Royaume.");
        return;
    }

    saveConfig();

    // Mots
    const wordPairs = [
        ["ChÃ¢teau", "Forteresse"],
        ["Dragon", "Serpent"],
        ["Ã‰pÃ©e", "Dague"],
        ["Couronne", "DiadÃ¨me"],
        ["Chevalier", "Soldat"]
    ];

    let pair = wordPairs[Math.floor(Math.random()*wordPairs.length)];
    villageWord = pair[0];
    renegatWord = pair[1];

    players = names.map(name => ({
        name: name,
        role: "Villageois",
        word: villageWord,
        alive: true
    }));

    shuffle(players);

    // Attribution RenÃ©gats
    for(let i = 0; i < impostors; i++){
        players[i].role = "RenÃ©gat";
        players[i].word = renegatWord;
    }

    // Attribution Idiots
    let index = impostors;
    for(let i = 0; i < idiotCountValue; i++){
        players[index].role = "Idiot du Royaume";
        players[index].word = "";
        index++;
    }

    currentPlayer = 0;
    showRole();
}

function showRole(){
    if(currentPlayer >= players.length){
        roleReveal.innerHTML = "<button onclick='startVote()'>Passer au vote</button>";
        return;
    }

    let p = players[currentPlayer];

    roleReveal.innerHTML = `
        <h2>${p.name}</h2>
        <p>RÃ´le : <b>${p.role}</b></p>
        <p>${p.word ? "Mot : <b>" + p.word + "</b>" : "Tu n'as aucun mot."}</p>
        <button onclick="nextPlayer()">Joueur suivant</button>
    `;
}

function nextPlayer(){
    currentPlayer++;
    showRole();
}

function startVote(){
    roleReveal.innerHTML = "";
    voteSection.innerHTML = "<h3>Votez un joueur Ã  Ã©liminer</h3>";

    players.filter(p => p.alive).forEach(p => {
        voteSection.innerHTML += `
            <button onclick="eliminate('${p.name}')">${p.name}</button>
        `;
    });
}

function eliminate(name){

    let player = players.find(p => p.name === name);
    player.alive = false;

    voteSection.innerHTML = "";
    resultScreen.innerHTML = `
        <h3>${player.name} Ã©tait ${player.role}</h3>
        <p>Mot des Villageois : ${villageWord}</p>
        <p>Mot des RenÃ©gats : ${renegatWord}</p>
    `;

    checkVictory();
}

function checkVictory(){

    let renegatsAlive = players.filter(p => p.role === "RenÃ©gat" && p.alive).length;
    let villageoisAlive = players.filter(p => p.role === "Villageois" && p.alive).length;

    // Cas sans RenÃ©gat
    if(parseInt(renegatInput.value) === 0){
        resultScreen.innerHTML += `
            <h2>ðŸŽ‰ Les Villageois survivent dans un royaume sans traÃ®tre !</h2>
            <button onclick="location.reload()">Nouvelle partie</button>
        `;
        return;
    }

    if(renegatsAlive === 0){
        resultScreen.innerHTML += `
            <h2>ðŸŽ‰ Victoire des Villageois !</h2>
            <button onclick="location.reload()">Nouvelle partie</button>
        `;
        return;
    }

    if(renegatsAlive >= villageoisAlive){
        resultScreen.innerHTML += `
            <h2>ðŸ’€ Victoire des RenÃ©gats !</h2>
            <button onclick="location.reload()">Nouvelle partie</button>
        `;
        return;
    }

    resultScreen.innerHTML += `
        <button onclick="startVote()">Continuer</button>
    `;
}

window.onload = loadConfig;
</script>
